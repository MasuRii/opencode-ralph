name: publish

on:
  push:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: "Override version (optional, e.g. 1.2.3)"
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install

      - name: Publish to npm
        id: publish
        run: bun run scripts/publish.ts
        env:
          RALPH_BUMP: ${{ inputs.bump }}
          RALPH_VERSION: ${{ inputs.version }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Package release binaries
        if: ${{ steps.publish.outputs.version != '' }}
        run: |
          version="${{ steps.publish.outputs.version }}"
          mkdir -p release-assets
          for dir in dist/openralph-*; do
            if [ ! -d "$dir/bin" ]; then
              continue
            fi
            pkg=$(basename "$dir")
            if [ -f "$dir/bin/ralph.exe" ]; then
              tar -czf "release-assets/${pkg}-${version}.tar.gz" -C "$dir" bin/ralph.exe
            elif [ -f "$dir/bin/ralph" ]; then
              tar -czf "release-assets/${pkg}-${version}.tar.gz" -C "$dir" bin/ralph
            fi
          done

      - name: Create GitHub release
        if: ${{ steps.publish.outputs.version != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.publish.outputs.version }}"
          prerelease="${{ steps.publish.outputs.prerelease }}"
          tag="v${version}"

          if gh release view "$tag" >/dev/null 2>&1; then
            echo "Release $tag already exists."
            exit 0
          fi

          flags=(--generate-notes --title "$tag" --target "$GITHUB_SHA")
          if [ "$prerelease" = "true" ]; then
            flags+=(--prerelease)
          fi

          gh release create "$tag" "${flags[@]}"

      - name: Upload release binaries
        if: ${{ steps.publish.outputs.version != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="v${{ steps.publish.outputs.version }}"
          if ls release-assets/*.tar.gz >/dev/null 2>&1; then
            gh release upload "$tag" release-assets/*.tar.gz --clobber
          else
            echo "No release assets found to upload."
          fi

      - name: Summary
        run: |
          echo "## Publish Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.bump }}" ]; then
            echo "- **Type**: Production release (${{ inputs.bump }} bump)" >> $GITHUB_STEP_SUMMARY
          elif [ -n "${{ inputs.version }}" ]; then
            echo "- **Type**: Production release (version ${{ inputs.version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Type**: Preview release" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Install**: `bun install -g openralph`" >> $GITHUB_STEP_SUMMARY
